# 10장 사용자에게 푸시 알림 보내기

## 푸시 알림의 생애

푸시 알림은 사시 하나로 이루어지지 않았습니다. 푸시알림은 사실 **Push API**를 사용하여 전송된 **메시지**와 **Notification API**를 사용하여 보여지는 **알림** 두가지 기능으로 이루어져 있습니다.



## Notification API

Notification API를 사용하면 웹페이지나 서비스워커가 시스템알림을 생성하고 표시할 수 있다. 사용자 알림을 표시하기 전에 우선 사용자에게 권한을 요철해야 합니다. 아래의 코드를 참고

```javascript
Notification.requestPermission().then(function(permission) {
  if (permission === "granted") {
    new Notification("Shiny");
  }
});
```

알림 표시 권한을 요청하는 것은 이 샘플 코드하나로 충분하다. 그리고 권한 부여가 된다면 Shiny라는 이름의 알람이 생성된다. 



## Push API

Push API를 사용하면 앱 사용자는 서버에서 보낸 푸시메시지를 구독하고 서버에서는 언제든지 브라우저로 메시지를 전송 할 수 있다. **푸시메시지는 서비스워커에 의해 제어**된다.  푸시메시지는 사용자기기에 언제든지 끊임없이 푸시를 보내 사용자를 괴롭히거나 서비스워커에서 사용자의 현재상태에 관한 데이터를 계속 전송하여 조용하게 사용자를 추적할 수 있습니다. 이런식으로 Push API가 남용되지 않도록 모든 푸시는 중앙 메시징 서버를 통해서 전달된다. 



## 푸시 알람의 간단한 과정 

이해하기 쉽도록 간단하게 4가지 과정으로 나누어 설명한다.

처음 두 단계는 **'푸시이벤트 구독하기'**와 **'서버에 구독 세부내용 저장하기'**이고 각각의 사용자는 이단계를 한 번씩 거치게된다.

마지막 두 단계는 **'서버에서 메시지 전달하기'**와 **'브라우저에서 작업하기'**입니다. 이 두 단계는 사용자에게 메시지를 전송할 때마다 발생합니다. 

먼저, 처음 두 단계는 웹페이지에서 Push API의 subscribe() 메소드를 호출합니다.  메소드가 호출되면 중앙메시징 **서버로 구독요청이 전달**되고 중앙서버는 신규 구독 상세정보를 페이지로 반환한다.  구독 상세 정보를 받은 페이지는 이 정보를 나중에 사용할 수 있도록 **앱 서버로 전송**한다.이때 구독 상세정보는 사용자 **상세정보를 저장**하는 테이블이나 객체저장소에 함께저장하는 겅우가 많습니다.

다음으로 마지막 두 단계는 메시지를 전송 할 때마다 필요한 두 단계로 우리의 앱서버는 이전에 저장해 두었던 **구독 세부 정보를 가져와서 메시징 서버로 메시지를 전송**할 떄 사용한다. 메시징 서버는 이 메시지를 받아 사**용자 브라우저로 전달**합니다.마지막으로 **사용자 브라우져에 등록된 서비스 워커는 메시지를 수신**하여 그 내용을 읽고 어떤 작업을 수행할지 결정합니다. 



## 푸시 알림 프로세스

사용자에게 푸시 알람을 전송하는 전체 프로세스를 확인해봅시다.

1. 페이지가 사용자에게 **알림을 보여주기 위한 권한을 요청**하면 사용자가 권한을 부여합니다.
2. 페이지가 **중앙 메시징 서버에 접속해 신규 구독 생성을 요청**합니다. 
3. **메시징 서버는 새로운 구독 세부 정보 객체를 응답**으로 반환합니다.
4. 페이지는 **우리의 앱 서버로 구독 세부 내용을 전달**합니다.
5. 우리의 앱 서버는 다음에 사용하기 위해 **구독 세부 정보**를 저장합니다.
6. 시간이 흘러 알림을 보낼 필요가 생겼습니다.
7. 우리의 앱 서버는 **저장했던 구독 세부 정보를 사용하여 사용자에게 보낼 메시지를 메시징 서버로 전송**합니다.
8. **메시징 서버는 사용자 브라우져로 메시지를 전달**합니다.
9. **서비스워커의 'push' 이벤트 리스너가 메시지를 수신**합니다.
10. **서비스워커가 메시지의 내용을 기반으로 알림을 표시**합니다. 



## 직접 알림 생성하기

이제 첫번째 알림을 만들어 봅시다.

### 알림을 윈한 권한 요청하기

우선 기본적으로 권한을 요청받아야한다. 현재 페이지가 권한을 가지고 있는지는 Notification.permission 속성값을 확인하면 알 수 있습니다.  또한 **Notification.requestPermission();**을 사용하여 권한을 요청하는 UI를 보여줄 수 있다. 

이때 Notification.requestPermission();는 사용자가 선택한 권한에 프로미스를 반환하는데 이 **프로미스는 resolve만 있다**. 즉 사용자가 권한을 수락하거나 거절하거나 그냥 창을 닫아버리는 상황에도 resolve가 된다.  그렇기 때문에 권한을 요청한 뒤에 혹은 알림을 생성하기 전에 현재의 권한 상태를 확인 해야합니다. 아래의 코드를 참고합니다

```javascript
Notification.requestPermission().then(function(permission) {
        if (permission === "granted") {
          console.log("이러면 권한이 있는 겁니다.");
          //알림을 보인다.
          showNotification();
        } else if (permission === "default") {
          console.log("사용자가 아무결정을 하지 않음");
        } else if (permission === "denied") {
          console.log("거절된 권한");
        }
});
```

* 사용자가 권한을 **승낙** & 알림 표시권한 **있음** : "granted"
  * requestPermission이 호출되었고 사용자가 이를 승인 했습니다 혹은 requestPermission이 호출되었지만 이전에 이미 권한을 부여받은 적이 있으므로 권한요청을 하지 않습니다.
* 사용자가 아직 **결정하지 않음** & 알림 표시권한 **없음** : "default"
  * 현재 페이지에는 알림을 표시항 권한이 없습니다. requestPermission가 호출되었지만 사용자는 아무런 결정을 하지 않고 창을 닫아 버렸습니다.
* 사용자가 권한을 **거부** & 알림 표시권한 **없음** : "denied"
  * requestPermission이 호출되었지만 사용자는 권한을 거절했습니다. 혹은 requestPermission가 호출되었지만 이전에 이미 권한을 거절한 적이 있으므로 권한 요청을 할 수 없습니다.



### 알림 표시하기

이제 새로운 알림을 생성해봅시다. 새로운 Notification객체를 생성하면 됩니다. 아래의 코드를 참고합시다.

```javascript
Notification.requestPermission().then(function(permission) {
    if (permission === "granted") {
        console.log("이러면 권한이 있는 겁니다.");
          //알림을 생성한다.
        new Notification("알람!");
    }
});
```

권한을 요청한 뒤에 알람! 이라는 알람이 생길것입니다! 

하지만....이 코드는 모바일에서는 작동하지 않고 **데스크탑에서 만** 잘 작동하는 모습을 보여줍니다ㅠㅠ 이것을 이해하기 위해서는 모바일에서 알람이 어떻게 작동되는지 알아야합니다! 

페이지가 알림을 생성하면 알림은 브라우저 밖(운영체제 레벨)에서 렌더링됩니다. 시용자가 사이트를 떠난지 한참이 지나도 이 알람은 표시될 것이고 사용자는 이 알람과 **상호 작용**할 수 있습니다. 알림과 상호작용을 할 수 있으려면 알림이 상위레벨 즉, 서비스워커에 위치해야합니다.

데스크톱과 모바일에서 모두 작동가능한 알림을 설정하려면 **서비스워커를 통해 알림을 생성**해야 합니다. 이때 우리는 서비스워커의 코드를 직접 수정하지 않아도 페이지에서 **서비스워커의 registration객체에서 showNotification()을 호출**할 수 있다. 아래의 코드를 참고하자.

```javascript
Notification.requestPermission().then(function(permission) {
    if (permission === "granted") {
           navigator.serviceWorker.ready.then(function(registration) {
              registration.showNotification("알림입니다");
       });
        }
});
```

#### 이제 알림을 좀더 멋지게 꾸며볼까요?

아래의 코드와 주석을 읽어보자

```javascript
Notification.requestPermission().then(function(permission) {
  if (permission === "granted") {
    navigator.serviceWorker.ready.then(function(registration) {
      registration.showNotification("멋진 알림!!!", {
        //알림내 텍스트 본문
        body: "PWA 알림은 멋지다",
        //알림의 포시될 이미지 URL
        icon: "/img/reservation-gih.jpg",
        //알림을 보낸 앱을 상징하는 뱃지 혹은 알림의 종류에 따라 성절하기도 함
        badge: "/img/icon-hotel.png",
        //알림을 나타내는 고유 식별자이다. 만약 지금 표시된 알림과 같은 태그를 사용한다면 예전 알림은 조용히 새 알림으로 대체됩니다!
        tag: "멋진 알림",
        //알림에 액션 객체를 이용하여 최대 2개의 버튼을 추가 할 수 있고 이것으로 알림에서 바로 작업을 할 수 있다. (나중에 더 자세히)
        actions: [
          {
            action: "confirm1",
            title: "맞아!",
            icon: "/img/icon-confirm.png"
          },
          {
            action: "confirm2",
            title: "아니야!",
            icon: "/img/icon-cal.png"
          }
        ],
        //진동이다.배열의 값은 진동시간, 정지시간을 의미한다.
        // 500ms 진동 -> 110ms 정지 -> 500ms 진동 .......
          //근데 왜 내폰에서는 기본 진동만울리지... 지우면 안나지만 배열의 인자가 하나도없지만 진동은 기본진동이 울리넹
        vibrate: [
          500,
          110,
          500,
          110,
          450,
          110,
          200,
          110,
          170,
          40,
          450,
          110,
          200,
          110,
          170,
          40,
          500
        ]
      });
    });
  }
});
```

아직 우리는 Notification을 배웠습니다. 사용자가 홈페이지에 머무르지 않을때도 알림을 보내고 싶습니다.

우리의 호텔앱을 발전시키면서 푸시알림을 구현 해봅시다.



## 우리의 호텔 앱에 푸시 이벤트 추가하기

호텔앱에 알림기능을 지원합니다. 