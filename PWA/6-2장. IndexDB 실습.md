# 고담호텔에서 IndexDB 실습하기

## 기본적으로 주어지는 my-account.js

현재 기본적으로 제공하는 my-acount.js는 아래와 같으며 몇가지의 기능을 수행하는 코드들입니다.

```javascript
$(document).ready(function() {

  // 사용자 예약을 가져와서 렌더링하기
  populateReservations();

  // 위젯기능 추가
  $("#reservation-form").submit(function(event) {
    event.preventDefault();
    var arrivalDate = $("#form--arrival-date").val();
    var nights = $("#form--nights").val();
    var guests = $("#form--guests").val();
    var id = Date.now().toString().substring(3, 11);
    if (!arrivalDate || !nights || !guests) {
      return false;
    }
    addReservation(id, arrivalDate, nights, guests);
    return false; 
  });

  // 주기적으로 미확인된 예약 확인
  setInterval(checkUnconfirmedReservations, 5000);
});

//서버에서 예약을 기저와 페이지 렌더링하기
var populateReservations = function() {
  $.getJSON("/reservations.json", renderReservations);
};

// 각각의 미확인된 예약상태를 서버에서 확인하기
var checkUnconfirmedReservations = function() {
  $(".reservation-card--unconfirmed").each(function() {
    $.getJSON("/reservation-details.json", {id: $(this).data("id")}, function(data) {
      updateReservationDisplay(data);
    });
  });
};

// DOM에 예약을 대기로 추가하고 서버에 예약을 시도하기
var addReservation = function(id, arrivalDate, nights, guests) {
  var reservationDetails = {
    id:           id,
    arrivalDate:  arrivalDate,
    nights:       nights,
    guests:       guests,
    status:       "Awaiting confirmation"
  };
  renderReservation(reservationDetails);
  $.getJSON("/make-reservation", reservationDetails, function(data) {
    updateReservationDisplay(data);
  });
};
```



우리는 두 단계를 거쳐 IndexDB로 업그레이드를 진행한다.

1. 네트워크에서 가져온 모든 예약을 로컬데이텁이스에 저장하도록 코드를 수정한다.
   * 수정된 populateReservations()는 언제나 대이터베이스에서 예약 데이터를 읽어오여고 할 것이며 로컬데이터가 없는 경우에만 네트워크로 복귀한다.
2. 새 예약을 추가하는 코드와 네트워크에서 주기적으로 예약상태를 가져오는 코드를 수정할 것이다.



## 기본세팅

우선 js폴더에 reservations-store라는 빈 파일을 추가한다. 여기에는indexDB관련 코드가 들어갈 예정이다. 

다음으로 my-account.html에 하단에 방금만든js 파일을 로드합니다.

그리고 사용자가 오프라인 일때를 위해 서비스워커에 CACHED_URLS 배열에 "/JS/reservations-store.js"를 추가



IndexDB 코드부터 사작하기위해 reservations-store.js파일에 아래의 코드를 추가하자

```javascript
var openDatebase = function() {
    //IndexDB를 사용하기 전에 사용가능한지 체크한다.
    if (!window.indexedDB) {
        return false;
    }

    var request = window.indexedDB.open('gih-reservations', 1);
    request.onerror = function(event) {
        console.log('ERROR : ', event.target.error);
    };
    request.onupgradeneeded = function(event) {
        var db = event.target.result;
        if (!db.objectStoreNames.contains('reservations')) {
            db.createObjectStore('reservations', {
                keyPath: 'id'
            });
        }
    };
    return request;
};
var openObjectStore = function(storeName, successCallback, transactionMode){
    var db = openDatebase();
    if (!db){
        return false;
    }
    db.onsuccess = function(event){
        var db = event.target.result;
        var objectStore = db
        .transaction(storeName,transactionMode)
        .objectStore(storeName);
        successCallback(objectStore);
    };
    return true;
};

var getReservations = function(successCallback){
    var reservations = [];
    var db = openObjectStore("reservations", function(objectStore){
        objectStore.openCursor().onsuccess = function(event){
            var cursor = event.target.result;
            if (cursor){
                reservations.push(cursor.value);
                cursor.continue();
            }else{
                if (reservations.length > 0){
                    successCallback(reservations);
                }else{
                    $.getJSON("/reservations.json",function(reservations){
                        openObjectStore("reservations",function(reservationsStore){
                            for (var i = 0; i < reservations; i++){
                                reservationsStore.add(reservations[i]);
                            }
                            successCallback(reservations);
                        },"readwrite");
                    });
                }
            }
        };
    });
    if(!db){
        $.getJSON("/reservations.json",successCallback);
    }
};
```

위 코드는 데이터 베이스를 다루는데에 유용한 여러가지 함수를 정의한다.

**첫번째 함수 openDatebase()**는 데이터베이스에 새로운 요청을 열고 기본적인 에러 로깅 기능과 reservation 객체 저장소를 생성하는 upgrade메소드를 설정합니다. 만약 IndexDB가 지원되지 않는 경우를 대비도 한다.

**두번째 함수 openObjectStore()**는 객체 저장소의 트랜잭션을 열고 함수를 실행합니다. 첫 번째 인수로 객체저장소의 이름을 두번째 인수로 성공적으로 열릴 때 호출될 콜백 함수를 받고 세번째는 넣어도 선택옵션인 트랜잭션의 모드로 "readonly"(기본값)으로 열것인지"readwrite"로 열것인지 모드를 선택할 수 있다. 

**마지막으로 getReservations()**를 보자 이 함수는 사용자의 모든 예약을 **배열**로 받아 작업을 수행하는 콜백함수를 파라미터로 받습니다. 예약정보는 로컬 IndexDB 데이터 베이스나 서버로 부터 가져올 수 있다. 함수는 reservation 객체 저장소를 열고 커서를 생성한다. 그후 커서가 정보를 가리키고 있으면 예약 배열에 넣고 커서를 앞으로 이동 시킨다. 커서가 **아무것도 가리키지 않고 있다면 저장소가 비었거나 마지막에 도달했다는 뜻**이므로 예약정보가 담긴 배열을 확인합니다. 배열이 비어있지 않았다는 것은 **모든 예약이 담겼다는 뜻**으로 해당 배열을 인자로 successCallback을 호출한다. 만약 모든 저장소를 확인했는데 배열이 비어있으면 네트워크를 통해 reservation.json을 요청한다. 



## 직접 사용해보자

기존의 my-account.js에 populateReservations함수의 코드는 아래와 같습니다.

```javascript
var populateReservations = function() {
  $.getJSON("/reservations.json", renderReservations);
};
```

getJOSN을 호출하여 예약 객체 배열을 가져온다음 이를 콜백함수로 전달한다.

위의 코드를 아래와 같이 바꾸자

```javascript
var populateReservations = function() {
    getReservations(renderReservations);
};
```

이제 다시 페이지를 방문하면 데이터베이스가 생성되고 reservations.json에 네트워크 요청은 없을 것이고 데이터는 로컬데이터베이스에서 직접로드될 것이다.

### 예약 상태변경

사용자가 새로운 예약을 생성하거나 기존 예약 상태를 변경한다면 로컬 데이터베이스에 데이터가 한번저장 되고 나면 예약된 데이터가는 바뀌지 않은 채로 남는다. 이 내용을 고치기위해 2가지 함수를 더 작성해보자

```javascript
var addToObjectStore = function(storeName,object){
    openObjectStore(storeName,function(store){
        store.add(object);
    },"readwrite");
};

var updateInObjectStore = function(storeName,id,object){
    openObjectStore(storeName,function(objectStore){
        objectStore.openCursor().onsuccess = function(event){
            var cursor = event.target.result;
            if (!cursor){
                return ;
            }
            if (cursor.value.id === id){
                cursor.update(object);
                return ;
            }
            cursor.continue();
        };
    },"readwrite");
};    

```

첫번째 함수는 객체 저장소 이름과 그 안에 저장될 새 객체를 인자로 받는다  예를들어 아래와 같이 쓸 수 있다.

```javascript
//예약 저장소에 id 111인 2일 밤자는 3명의 예약
addToObjectStore("reservations",{id : 111, night : 2, guests : 3});
```

두번째 함수는 객체 저장소의 이름과 id 그리고 해당 id를 업데이트할 object를 받는다. 주어진 id와 일치하는 객체를 찾은다음 새로운 객체로 업데이트한다. 이것은 readwrite 트랜잭션을 열고 커서로 순회하는 방법이 있다. 

```javascript
//11의 id를 가진 예약의 정보를 저렇게 바꾼다
updateInObjectStore("reservations",111,{id : 111, night : 3, guests : 5});
```



### IndexDB에 적용

이제 데이터를 추가하거나 업데이트할 때 위의 두함수를 호출해보자

새 예약을 추가하기 전에 addToObjectstore()를 호출하도록 my-account.js의 addReservation을 업데이트하자

```javascript
var addReservation = function(id, arrivalDate, nights, guests) {
    var reservationDetails = {
        id:           id,
    	arrivalDate:  arrivalDate,
    	nights:       nights,
    	guests:       guests,
    	status:       "Awaiting confirmation"
    };
    //코드 한줄을 추가했다.
    addToObjectStore("reservations",reservationDetails);  
  	renderReservation(reservationDetails);
  	$.getJSON("/make-reservation", reservationDetails, function(data) {
        updateReservationDisplay(data);
    });
};
```

서버에서 새 데이터를 받을 때마다 updateInObjectStore()를 호출하기위해 checkUnconfirmedReservations함수르 변경하자

```javascript
var checkUnconfirmedReservations = function() {
    $(".reservation-card--unconfirmed").each(function() {
        $.getJSON("/reservation-details.json", {id: $(this).data("id")}, function(data) {
            //코드 한줄을 추가했다.
            updateInObjectStore("reservations",data.id,data);
            updateReservationDisplay(data);
        });
    });
};
```



## 프로미스를 활용한 데이터베이스

콜백에 크게 의존하는 indexDB의 예시를 보고 이를 어떻게 프로미스로 변환하는지 봅시다.

```javascript
var 
```

